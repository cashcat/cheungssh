function getKey(key) {
    // è·å–URLä¸­?ä¹‹åçš„å­—ç¬¦  
    var str = location.search;
    str = str.substring(1,str.length);

    // ä»¥&åˆ†éš”å­—ç¬¦ä¸²ï¼Œè·å¾—ç±»ä¼¼name=123è¿™æ ·çš„å…ƒç´ æ•°ç»„  
    var arr = str.split("&");
    var obj = new Object();

    // å°†æ¯ä¸€ä¸ªæ•°ç»„å…ƒç´ ä»¥=åˆ†éš”å¹¶èµ‹ç»™objå¯¹è±¡      
    for(var i = 0; i < arr.length; i++) {
        var tmp_arr = arr[i].split("=");
        obj[decodeURIComponent(tmp_arr[0])] = decodeURIComponent(tmp_arr[1]);
    }
    return obj[key];
}


//å‘½ä»¤æœç´¢

$(function () {
    var cache = {};  //ç¼“å­˜åŠŸèƒ½
    $("#inputCommand").autocomplete({
        minLength: 1, //æœ€å°‘å¤šå°‘å¼€å§‹æœç´¢
        source: function (request, response) {
            var path = request.term;  //è‡ªèº«æºå¸¦çš„æ˜¯term key
            var requestData = {"path": path};
            if (path in cache) {
                response(cache[path]);
                return;
            }

            $.getJSON(headURL + pathSearchURL, requestData, function (data, status, xhr) { //requestDataæ˜¯ç»„æˆçš„æ•°æ®
                var content = data.content;
                cache[path] = content;
                response(content);
            });
        }
    });
});



//åˆ›å»ºCRTçª—å£
function createCRTWindow() {
    var showCRTWindow = document.getElementById("showCRTWindow");
    showCRTWindow.innerHTML = ""//æ¸…ç©ºCRTçª—å£ï¼Œé¿å…é‡å¤æ˜¾ç¤º
    var CRTWindowExample = document.getElementById("CRTWindowExample");
    var serverList=getKey("serverList")
    serverList = JSON.parse(serverList)
    for (var i = 0; i < serverList.length; i++) {
	//å–å¾—ID
	var sid = serverList[i]["sid"];
	var username = serverList[i]["username"];
	var alias = serverList[i]["alias"];
        //åˆ›å»ºCRT
        var t = CRTWindowExample.cloneNode(true);
        t.setAttribute("id", sid);//ajaxè®¿é—®åç«¯çš„æ—¶å€™ï¼Œéœ€è¦ä½¿ç”¨è¿™ä¸ªsid
        $(t).addClass("CRT");//å¢åŠ ç±»ï¼Œæœ‰jsé€šè¿‡è¿™ä¸ªCRTç±»æ§åˆ¶ä¿®æ”¹çª—å£å¤§å°
        $(t).find(".title")[0].textContent = username + "@" + alias;//è¡¨å¤´ä¿®æ”¹ä¸ºåˆ«å
        //t.removeAttribute("id");//åˆ é™¤æ ·æœ¬HTMLçš„id
        t.style.display = "block";
        showCRTWindow.appendChild(t);


    }
}



function createMyCommandHistory(command) {
    var showCommandHistory = document.getElementById("showCommandHistory");
    //å¢åŠ å‘½ä»¤è®°å½•
    var label = document.createElement("label");
    label.className = "pull-left  label label-success";           //å¯ä»¥æ ¹æ®å‘½ä»¤è¿”å›çš„çŠ¶æ€ç”Ÿæˆç»¿è‰²æˆ–è€…çº¢è‰²
    label.textContent = command;
    label.style.cssText = "position: relative;cursor:pointer;border-radius:5px;margin-left:5px;";
    label.onclick = function () {
        var inputCommand = document.getElementById("inputCommand");
        inputCommand.value = this.textContent;
        document.getElementById("inputCommand").focus();//è¾“å…¥æ¡†è·å–å…‰æ ‡

    }

    showCommandHistory.appendChild(label);
}


function loadMyCommandHistory() {
    jQuery.ajax({
        "url": myCommandHistoryURL,
        "dataType": "jsonp",
        "beforeSend": start_load_pic,
        "complete": stop_load_pic,
        "error": errorAjax,
        "success": function (data) {
            responseCheck(data);
            if (data.status) {
                var content = data.content;
                for (var i = 0; i < content.length; i++) {
                    createMyCommandHistory(content[i]);
                }

            }
        }
    });
}


function processProgress(sid, content) {
    //æ˜¾ç¤ºå‘½ä»¤ç»“æœ
    try {
        if (content.content === "") {
            return false;
        }
        var crt = document.getElementById(sid);
        var pre = $(crt).find("pre")[0];
	var length=window.currentCommand.split(" ")[0].split("/").length-1
        //pre.innerHTML = pre.textContent + content.content;
        if (window.currentCommand.split(" ")[0].split("/")[length] === "top") {
		//æ¥æ”¶åˆ°çš„æ–°æ¶ˆæ¯
		var recvContent = (window.topContentMemory[sid] + content.content).split(/top \- /)
		//console.log(recvContent)
		var recvContentLength = recvContent.length;
		if (recvContent.slice(1,recvContentLength).length === 0){
			return false;
		}
		//ç”¨å†…å­˜è®°å½•ä¸‹æ‰€æœ‰æ”¶åˆ°çš„æ•°æ®ï¼Œä¸€æ¬¡æ˜¾ç¤ºä¸€é¡µ
		window.topContentMemory[sid] = recvContent.slice(1,recvContentLength).join("\r\n")
		if(recvContentLength > 0){
			//preä¸æ”¯æŒ\r\n
			var terminalContentLines=pre.innerHTML.split("\n");
			//Webé¡µé¢å·²ç»æ˜¾ç¤ºçš„æ¶ˆæ¯,åˆ‡å‰²æˆæ¯ä¸€è¡Œ
			var recvContentLines=recvContent[0].split("\r\n")
			for (var i=0;i<recvContentLines.length;i++){
				//var recvLine = recvContentLines[i].replace(/\\[6;1H/,"").replace(/(\){1,}/,"")
				var recvLine = recvContentLines[i]
				if (i=== 0){
					terminalContentLines[i] = "top - " + recvLine
					continue
				}
				if (i + 1 <= terminalContentLines.length){
					// æ›¿æ¢
					if (recvContentLines[i].match(/^ *$/)){
						//å¦‚æœæ˜¯ç©ºè¡Œåˆ™è·³è¿‡
						continue
					}
					else{
						//çœŸæ­£çš„æ›¿æ¢
						if(terminalContentLines[i].match(/PID/)){
							if (recvLine.match(/PID/)){
							}
							else{
								alert("æ„å¤–å‡ºç°")
							}
						}
						terminalContentLines[i] = recvLine
						
					}
				}
				else{
					//æ–°å¢
					terminalContentLines.push(recvLine)
				}
			}
			//æ‹¼æ¥å­—ç¬¦ä¸²
			pre.innerHTML = terminalContentLines.join("\r\n")
		}
        }
	else{
		pre.innerHTML = pre.innerHTML + content.content;
	}
        if (content.status == false) {
            pre.style.color = "red";
        }
        if (window.currentCommand.split(" ")[0].split("/")[length] === "top") {
		pre.scrollTop = pre.scrollTop;//æŠŠæ»šåŠ¨æ¡è®¾ç½®åˆ°æœ€é¡¶éƒ¨éƒ¨ï¼Œè¿™æ ·æœ‰æ›´æ–°çš„æ•ˆæœï¼Œè·ŸCRTä¸€æ ·
	}
	else{
		pre.scrollTop = pre.scrollHeight;//æŠŠæ»šåŠ¨æ¡è®¾ç½®åˆ°æœ€åº•éƒ¨ï¼Œè¿™æ ·æœ‰æ›´æ–°çš„æ•ˆæœï¼Œè·ŸCRTä¸€æ ·
	}
    }
    catch (e) {
        console.log(e, "å‘ç”Ÿé”™è¯¯");
    }

}


//ç”¨æ¥ç»™setTimeoutä¼ é€’å‚æ•°çš„ï¼Œé»˜è®¤çš„setTimeoutæ˜¯ä¸å¯ä»¥æºå¸¦å‚æ•°çš„
function _getCommandResult(tid, sid) {
    return function () {
        //è®¿é—®çœŸæ­£çš„ç›®æ ‡å‡½æ•°
        getCommandResult(tid, sid);
    }
}


function getCommandResult(tid, sid) {
    var data = {"tid": tid, "sid": sid};
    jQuery.ajax({
        "url": getCommandResultURL,
        "dataType": "jsonp",
        "data": data,
        "error": errorAjax,
        "success": function (data) {
            responseCheck(data);
            if (data.status) {
                var progress = document.getElementById("commandProgress").style.width = data.progress + "%";    //æ˜¾ç¤ºè¿›åº¦
                var showProgress = document.getElementById("showCommandProgress").textContent = data.progress + "%";
                //if (data.content.stage === "running") {  //stageæ˜¯runningæˆ–è€…done
                if (data.progress <100) {  //stageæ˜¯runningæˆ–è€…done
                    //å½“å‰å‡½æ•°çš„é˜¶æ®µæ²¡æœ‰å®Œæˆï¼Œç»§ç»­è·å–
                    setTimeout(_getCommandResult(tid, sid), 500);
                }

                if (data.progress == 100) {
                    $("#showExecuteRefresh").text("æ‰§è¡Œ").removeClass("fa-refresh fa fa-spin");
                    //$("#commandProgress").removeClass("active");  //è¿›åº¦æ¡ä¸è¦åŠ¨ç”»
                    document.getElementById("commandProgress").style.width = "0%";
                    document.getElementById("showCommandProgress").textContent = "0%";
                    document.getElementById("inputCommand").removeAttribute("disabled");
                    $("#execute").find("button")[0].removeAttribute("disabled");
                    document.getElementById("inputCommand").focus();
                    showSuccessNotice();
                }
                processProgress(sid, data.content);//æ˜¾ç¤ºæ¶ˆæ¯
            }
		else{
			showErrorInfo(data.content)
			return false;
		}

        }
    });


}

function executeCommand(command, force) {
	var serverList=getKey("serverList");
	serverList=JSON.parse(serverList)
	var servers=[];
	for (var i=0;i<serverList.length;i++){
		servers.push(serverList[i]["sid"])
	}
	var data = {"cmd": command, "servers": servers};
	//forceæ˜¯å¦å¼ºåˆ¶æ‰§è¡Œ
	data["force"] = force;
	data["task_type"] = "cmd";
	data["multi_thread"] = true;

    //document.getElementById("inputCommand").setAttribute("disabled", "disabled");   //å‘½ä»¤æœªå®Œæˆï¼Œç¦ç”¨è¾“å…¥æ¡†
    //$("#execute").find("button")[0].setAttribute("disabled", "disabled");   //å‘½ä»¤æœªå®Œæˆï¼Œç¦ç”¨è¾“å…¥æ¡†
    //æ¸…é™¤è¿›åº¦æ¡
    /*try {
        document.getElementById("commandProgress").style.width = "0.1";
        document.getElementById("showCommandProgress").textContent = "0%";
        $("#commandProgress").addClass("active");
    }
    catch (e) {

    }*/
    //è®°å½•å½“å‰è¿è¡Œçš„å‘½ä»¤
    window.currentCommand = command;
    data = JSON.stringify(data);
    window.ajax = jQuery.ajax({
        "url": executeCommandURL,
        "dataType": "jsonp",
        "data": {"parameters": data},
	"error":errorAjax,
        "success": function (data) {
            responseCheck(data);
            if (!data.status) {
                document.getElementById("inputCommand").removeAttribute("disabled");
                //$("#execute").find("button")[0].removeAttribute("disabled");
                //$("#showExecuteRefresh").text("æ‰§è¡Œ").removeClass("fa-refresh fa fa-spin");//åŠ¨ç”»
                showErrorInfo(data.content);
                return false;
            }
            //å¦‚æœæ˜¯å‘½ä»¤æ‹’ç»
            if (data.ask) {
                //æœ‰äº¤äº’æç¤º
                startShadow();
                $("#confirmCommandDiv").show("fast");
                document.getElementById("showCommandWarn").innerHTML = data.content;
                return false;

            }
            if (data.status) {
                //å¢åŠ ä¹‹å‰å…ˆåˆ é™¤å¤´ä¸€ä¸ªï¼Œåªè®°å½•5ä¸ª
                if ($("#showCommandHistory").children().length >= 5) {
                    $("#showCommandHistory").children().eq(0).remove();
                }
                createMyCommandHistory(command);//å¢åŠ æ˜¾ç¤ºå‘½ä»¤å†å²

                var tid = data.content;
                for (var i = 0; i < servers.length; i++) {
                    getCommandResult(tid, servers[i]);
                }


            }


        }
    });

}


function startCommand() {
    //æ‰§è¡Œå‘½ä»¤
    //ç»™æ‰§è¡ŒæŒ‰é’®æ¢å›¾æ ‡
    commandInput = document.getElementById("inputCommand");
    //enableCrond(commandInput);
    command = commandInput.value;
    command = command.replace("\n", "");
    command = command.replace(/^ */, "");
    window.currentCommand = command;//ç”¨äºè®°å½•å½“å‰æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¸»è¦ä½¿ç”¨åœ¨å¼ºåˆ¶äº¤äº’çš„åœ°æ–¹
    commandInput.value = "";
    commandInput.focus();
    if (command == "clear") {
        document.getElementById("showCommandResult").innerHTML = "";
        return true;
    }
    else if (/^ *$/.test(command)) {
        return false
    }
    else if (/^ *(vi|vim|\/usr\/bin\/vim|\/bin\/vim|\/bin\/vi)/.test(command)){
        showErrorInfo(window.vimInfo);
	return false;
    }
    else if (/^ *(vi|vim|cd|\/usr\/bin\/vim|\/bin\/vim)/.test(command)){
        showErrorInfo(window.refuseInfo);
        return false;
    }

 	//$("#showExecuteRefresh").text("").addClass("fa-refresh fa fa-spin");//åŠ¨ç”»
	var length=command.split(" ")[0].split("/").length-1
        if (command.split(" ")[0].split("/")[length] === "top") {
		$("#showCRTWindow").find("pre").html("")
		serverList=JSON.parse(getKey("serverList"))
		//å­˜å‚¨å·²æ¥æ”¶åˆ°çš„æ‰€æœ‰æ¶ˆæ¯
		window.topContentMemory=[]
		for (var i=0;i<serverList.length;i++){
			//ç»™æ¯ä¸€ä¸ªæœåŠ¡å™¨å¼€è¾Ÿå‡ºä¸€ä¸ªç©ºçš„ç©ºé—´å­˜å‚¨æ‰€æœ‰topå†…å®¹
			window.topContentMemory[serverList[i]["sid"]] = ""
		}
	}
	executeCommand(command, false);


}
function _checkRequestConnect(rid) {
    return function () {
        //è®¿é—®çœŸæ­£çš„ç›®æ ‡å‡½æ•°
       checkRequestConnect(rid)
	}
}

function checkRequestConnect(rid){
	jQuery.ajax({
		"url":checkRequestConnectURL,
		"beforeSend":start_load_pic,
		"complete":stop_load_pic,
		"error":errorAjax,
		"data":{"rid":rid},
		"dataType":"jsonp",
		"success":function(data){
			responseCheck(data)
			if(!data.status){
				showErrorInfo(data.content);
				return false;
			}
			else{
				var content=data.content;
				if (window.currentSelectedServers.length!==content.length){
					setTimeout(_checkRequestConnect(rid), 1000);
				}
				else{
					//æ‰€æœ‰é“¾æ¥å·²ç»å®Œæˆ
					document.getElementById("inputCommand").removeAttribute("disabled")
					
				}
			}
		}
	})
}

$(function () {
	document.getElementById("inputCommand").focus();
	createCRTWindow();
    //ç»™ç‚¹å‡»è®¡åˆ’ä»»åŠ¡ç»‘å®šç‚¹å‡»äº‹ä»¶

    /*document.getElementById("addCrond").onclick = function () {
        loadCrond(this);
    }*/
    //è®¡åˆ’ä»»åŠ¡æŒ‰é’®é»˜è®¤æ˜¯ç¦ç”¨çš„

    //ç»‘å®šå‘½ä»¤æ¸…é™¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶


    //ç‚¹å‡»æ‰§è¡ŒæŒ‰é’®
    document.getElementById("execute").onclick = function () {
        startCommand();

    }
    //å‘½ä»¤è¾“å…¥æ¡†ç»‘å®šäº‹ä»¶
    //å¤„ç†è¾“å…¥æ¡†
    document.getElementById("inputCommand").onkeyup = function () {
        if (event.keyCode === 13) {
            startCommand(this);
        }
    }


    //åŠ è½½å‘½ä»¤å†å²
    //loadMyCommandHistory();

    //ç»‘å®šå‘½ä»¤ç¡®è®¤æ¡†çš„å…³é—­æŒ‰é’®
    document.getElementById("closeConfirmCommandButton").onclick = function () {
        stopShadow();
        $("#confirmCommandDiv").hide("fast");
        document.getElementById("shadow").style.display = "none";
        document.getElementById("inputCommand").removeAttribute("disabled");
        $("#execute").find("button")[0].removeAttribute("disabled");
        $("#showExecuteRefresh").text("æ‰§è¡Œ").removeClass("fa-refresh fa fa-spin");//åŠ¨ç”»
    }
    //ç»‘å®šå¼ºåˆ¶æ‰§è¡Œå‘½ä»¤æŒ‰é’®
    document.getElementById("forceExecuteCommand").onclick = function () {
        stopShadow();
        command = document.getElementById("inputCommand").value;

        executeCommand(window.currentCommand, true);
        $("#confirmCommandDiv").hide("fast");

    }

    //å¤„ç†CRTçª—å£çš„å°ºå¯¸
    if (window.innerWidth < 737) {

        var CRT = document.getElementsByClassName("CRT");
        for (var i = 0; i < CRT.length; i++) {
            CRT[i].style.width = "98%";
        }

    }

    //ç»‘å®šCRTå…¨å±ç‚¹å‡»äº‹ä»¶
    jQuery1_8("#fullScrenCRT").toggle(
        function () {
            //å…¨å±
            $(".CRT").css({
                "width": "98%",
            })


        }, function () {
            //è¿˜åŸå°ºå¯¸

            if (window.innerWidth > 737) {
                //åŠä¸ªå±å¹•
                $(".CRT").css({
                    "width": "48%",
                })
            }
            else {
                //æ‰‹æœºæ˜¯å…¨å±
                $(".CRT").css({
                    "width": "98%",
                })
            }

        }
    );

    //è¾“å…¥æ¡†ç„¦ç‚¹


})
